# Invokes Resource Group module
module "rg" {
  source   = "./modules/rg"
  prefix   = var.prefix
  location = var.location
}

# Invokes Virtual Network Module
module "network" {
  source          = "./modules/vnet"
  prefix          = var.prefix
  location        = var.location
  rg-name         = module.rg.rg_name
  vnet-cidr       = ["10.0.0.0/16"]
  pub-subnet-cidr = ["10.0.1.0/24"]
  pri-subnet-cidr = ["10.0.2.0/24"]
}

# Invokes Key Vault Module
module "kv" {
  source   = "./modules/kv"
  location = var.location
  rg-name         = module.rg.rg_name
  rg-id     = module.rg.rg_id
}

# Invokes Virtual Machine Module
module "vm" {
  source            = "./modules/vm"
  prefix            = var.prefix
  location          = var.location
  rg-name           = module.rg.rg_name
  size              = "Standard_DS1_v2"
  username          = "tf-admin"
  password       = module.kv.random-kv-password
  kali-nic          = module.network.kali_nic_output
  win-nic           = module.network.win_nic_output
  vm-tls-public-key = module.tls.vm-tls-public-key
}

# Invokes TLS Module
module "tls" {
  source = "./modules/tls"
}

# Invokes Locals Module
module "local" {
  source             = "./modules/local"
  vm-tls-private-key = module.tls.vm-tls-private-key
}

